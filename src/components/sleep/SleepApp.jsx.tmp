const AjaxSleepAppContent = ({ onBack, onLogout, user }) => {
  const points = usePoints();
  const [currentView, setCurrentView] = useState('home');
  const [parentMode, setParentMode] = useState(false);
  const [dailyGoals, setDailyGoals] = useState(0);
  const [weeklyGoals, setWeeklyGoals] = useState(18); // Start value for demo
  const [completedMissions, setCompletedMissions] = useState({});
  const [showReward, setShowReward] = useState(false);
  const [rewardType, setRewardType] = useState('');
  const [selectedPlayer, setSelectedPlayer] = useState('bergwijn');
  const [selectedOutfit, setSelectedOutfit] = useState('home');
  const [playerName, setPlayerName] = useState('Kampioen');
  const [dailyStreak, setDailyStreak] = useState(3);

  // State for the Pyjama-Dribbel input modal
  const [showDribbelInput, setShowDribbelInput] = useState(false);
  const [dribbelDare, setDribbelDare] = useState('');
  const [dribbelTry, setDribbelTry] = useState('');

  // State for the Gratitude input modal
  const [showGratitudeInput, setShowGratitudeInput] = useState(false);
  const [gratitude1, setGratitude1] = useState('');
  const [gratitude2, setGratitude2] = useState('');
  const [gratitude3, setGratitude3] = useState('');

  // Johan Cruijff quotes
  const cruijffQuotes = [
    "Elk nadeel heb z'n voordeel",
    "Je moet schieten, anders kun je niet scoren",
    "Voetbal is simpel, maar het moeilijkste wat er is, is simpel voetballen",
    "Je gaat het pas zien als je het doorhebt",
    "Als wij de bal hebben, kunnen zij niet scoren",
    "Als je ergens niet bent, ben je of te vroeg, of te laat",
    "Voetbal speel je met het hoofd, want de bal is vlugger dan de benen",
    "Voordat ik een fout maak, maak ik die fout niet"
  ];

  const [dailyQuote] = useState(() => {
    const randomIndex = Math.floor(Math.random() * cruijffQuotes.length);
    return cruijffQuotes[randomIndex];
  });
  
  const defaultMissions = [
    { id: 1, name: 'Kick-off Maaltijd', time: '18:00', goals: 0, points: 10, icon: 'üçΩÔ∏è', description: 'Eet samen en zeg waar je trots op bent.' },
    { id: 2, name: 'Chillen', time: '18:15', goals: 3, points: 30, icon: 'üòé', description: 'Even relaxen als een echte Ajax-ster.' },
    { id: 3, name: 'Warming-up Johan Cruijff', time: '18:45', goals: 2, points: 20, icon: 'üì∫', description: 'Kijk Klokhuis (max. 15 min) + 10 push-ups.' },
    { id: 4, name: 'Fris-op Vrije Trap', time: '19:15', goals: 1, points: 15, icon: 'üöø', description: 'Douchen/wassen, tanden poetsen, pyjama aan.' },
    { id: 5, name: 'Pyjama-Dribbel', time: '19:30', goals: 1, points: 15, icon: '‚úé', description: 'Schrijf: "Vandaag durfde ik..." & "Morgen ga ik proberen..."' },
    { id: 6, name: 'Dankbaarheid', time: '19:35', goals: 1, points: 20, icon: '‚≠ê', description: 'Schrijf 3 dingen waar je dankbaar voor bent.' },
    { id: 7, name: 'Bonuslevel voor Kampioenen', time: '19:40', goals: 0.5, points: 10, icon: '‚ö°', description: 'Kies 1: Puzzel, creatieve opdracht, of coachvraag.' },
    { id: 8, name: 'Finale Fluitsignaal', time: '20:00', goals: 2, points: 20, icon: 'üåô', description: 'Ogen dicht, glimlach en droom over...' }
  ];

  const weeklyRewards = {
      highfive: { threshold: 20, icon: 'üôå', title: 'Rood-Witte High-Five', message: '20 week-goals! Goed bezig!' },
      sticker: { threshold: 30, icon: '‚öΩ', title: 'Ajax Stickergool!', message: '30 week-goals! Plak die sticker op je poster!' },
      moment: { threshold: 35, icon: 'üë®‚Äçüë©‚Äçüëß', title: 'Johan Cruijff Moment', message: '35 week-goals! Tijd voor iets leuks met papa of mama!' },
      trophy: { threshold: 45, icon: 'üèÜ', title: 'Arena Trofee!', message: '45 week-goals! Een echte kampioen!' }
  };

  const ajaxPlayers = {
    bergwijn: { name: 'Steven Bergwijn', number: '7', emoji: '‚ö°' },
    tadic: { name: 'Du≈°an Tadiƒá', number: '10', emoji: 'üéØ' },
    timber: { name: 'Jurri√´n Timber', number: '2', emoji: 'üõ°Ô∏è' },
  };
  const outfits = {
    home: { name: 'Thuis', colors: 'from-red-600 to-red-800', jersey: 'üî¥' },
    away: { name: 'Uit', colors: 'from-blue-600 to-blue-800', jersey: 'üîµ' },
  };
  const badges = [
    { id: 'streak_3', name: 'Warme Start', description: '3 dagen op rij', icon: 'üî•', unlocked: true },
    { id: 'early_bird', name: 'Vroege Vogel', description: 'Voor 20:00 naar bed', icon: 'üê¶', unlocked: true },
    { id: 'perfect_week', name: 'Perfecte Week', description: 'Alle dagen 9.5/9.5 goals', icon: '‚≠ê', unlocked: false },
  ];
  const [missions, setMissions] = useState(defaultMissions);
  const playSound = (type) => { console.log(`üîä Playing ${type} sound`); };
  
  const completeMission = async (missionId) => {
    if (!completedMissions[missionId]) {
      const mission = missions.find(m => m.id === missionId);
      const newWeeklyTotal = weeklyGoals + mission.goals;

      setCompletedMissions(prev => ({ ...prev, [missionId]: true }));
      setDailyGoals(prev => prev + mission.goals);
      setWeeklyGoals(newWeeklyTotal);
      playSound('goal');

      // Add points for completing mission
      if (mission.points) {
        points.addPoints(mission.points, mission.name);
      }

      // Save to database
      if (user) {
        await dailyEntryService.saveCompletedMission(user.id, missionId);
      }

      // Check for early bird achievement
      const currentHour = new Date().getHours();
      if (missionId === 8 && currentHour < 20) {
        points.trackActivity('early_bird');
      }

      for (const [key, reward] of Object.entries(weeklyRewards)) {
          if (newWeeklyTotal >= reward.threshold && weeklyGoals < reward.threshold) {
              setRewardType(key);
              setShowReward(true);
              break;
          }
      }
    }
  };
  
  const handleDribbelSubmit = async () => {
      if(dribbelDare.trim() && dribbelTry.trim()) {
          // Save to database
          if (user) {
              await dailyEntryService.saveDribbelData(user.id, dribbelDare, dribbelTry);
          }

          completeMission(5);
          setDribbelDare('');
          setDribbelTry('');
          setShowDribbelInput(false);
      }
  };

  const handleGratitudeSubmit = async () => {
      if(gratitude1.trim() && gratitude2.trim() && gratitude3.trim()) {
          // Save to database
          if (user) {
              await dailyEntryService.saveGratitudeData(user.id, gratitude1, gratitude2, gratitude3);
          }

          completeMission(6);
          setGratitude1('');
          setGratitude2('');
          setGratitude3('');
          setShowGratitudeInput(false);
      }
  };

    const HomeScreen = () => (
    <div className="bg-gradient-to-b from-red-700 to-red-900 min-h-screen text-white">
      <div className="p-6">
        <div className="flex justify-between items-center mb-4">
           <button onClick={onBack} className="bg-white bg-opacity-20 p-2 rounded-full"><Home className="w-6 h-6" /></button>
          <h1 className="text-2xl font-bold">Avondritueel</h1>
          <button onClick={onLogout} className="bg-white bg-opacity-20 p-2 rounded-full"><LogOut className="w-6 h-6" /></button>
        </div>

        {/* Points & Level Display */}
        <div className="flex gap-2 mb-4">
          <button
            onClick={() => setCurrentView('points')}
            className="flex-1 bg-white bg-opacity-10 rounded-xl p-3 flex items-center justify-between hover:bg-opacity-20 transition-colors"
          >
            <div className="flex items-center space-x-2">
              <div className={`text-2xl bg-gradient-to-br ${points.currentLevel.color} w-10 h-10 rounded-full flex items-center justify-center`}>
                {points.currentLevel.badge}
              </div>
              <div className="text-left">
                <p className="text-xs opacity-75">Level {points.currentLevel.id}</p>
                <p className="font-bold text-sm">{points.currentLevel.name}</p>
              </div>
            </div>
            <div className="text-right">
              <p className="text-xs opacity-75">Punten</p>
              <p className="font-bold text-lg">{points.totalPoints}</p>
            </div>
          </button>
        </div>

        {/* Johan Cruijff Quote */}
        <div className="bg-white bg-opacity-10 rounded-2xl p-4 mb-6 border-2 border-white border-opacity-20">
          <p className="text-xs font-semibold mb-1 opacity-75">üí¨ Johan Cruijff zegt:</p>
          <p className="text-sm italic font-medium">"{dailyQuote}"</p>
        </div>
        <div className="text-center mb-8">
          <div className={`w-32 h-32 bg-gradient-to-br ${outfits[selectedOutfit].colors} rounded-full mx-auto mb-4 flex items-center justify-center relative border-4 border-white shadow-2xl`}>
            <div className="text-6xl">{ajaxPlayers[selectedPlayer].emoji}</div>
            <div className="absolute -bottom-2 -right-2 bg-white text-black px-2 py-1 rounded-full text-xs font-bold">#{ajaxPlayers[selectedPlayer].number}</div>
          </div>
          <h2 className="text-xl font-bold mb-1">{playerName}</h2>
          <p className="text-sm opacity-90 mb-2">speelt als {ajaxPlayers[selectedPlayer].name}</p>
        </div>
        <div className="bg-white bg-opacity-10 rounded-3xl p-6 mb-6">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-bold">Vandaag</h3>
            <div className="flex items-center"><Trophy className="w-5 h-5 mr-1" /><span className="font-bold">{dailyGoals.toFixed(1)}/9.5 goals</span></div>
          </div>
          <div className="bg-white bg-opacity-20 rounded-full h-4 mb-2"><div className="bg-green-400 h-4 rounded-full" style={{ width: `${Math.min((dailyGoals / 9.5) * 100, 100)}%` }}></div></div>
        </div>
        <div className="space-y-4">
            <button onClick={() => setCurrentView('missions')} className="w-full bg-white text-red-700 py-4 px-6 rounded-full font-bold text-lg flex items-center justify-center shadow-lg"><Play className="w-6 h-6 mr-2" />Start Missies!</button>
        </div>
      </div>
    </div>
  );
  
    const MissionsScreen = () => {
      const completedCount = Object.keys(completedMissions).length;
      const hasCompletedAny = completedCount > 0;

      // Calculate today's earned points
      const todayPoints = missions
        .filter(m => completedMissions[m.id])
        .reduce((sum, m) => sum + (m.points || 0), 0);

      const dreamMessages = [
        "...een geweldige goal die je scoort! ü•Ö",
        "...de mooiste pass die je geeft! ‚öΩ",
        "...een kampioenschap dat je wint! üèÜ",
        "...je vrienden en jullie samen lachen! üòÑ",
        "...de beste wedstrijd die je ooit speelt! ‚≠ê",
        "...een avontuur dat je beleeft! üåü",
        "...iets moois dat je morgen gaat doen! üåà",
        "...een moment waar je trots op bent! üí™",
        "...de Ajax Arena die voor jou juicht! üéâ",
        "...jouw allergrootste droom! ‚ú®"
      ];

      const [todayDream] = useState(() => {
        const randomIndex = Math.floor(Math.random() * dreamMessages.length);
        return dreamMessages[randomIndex];
      });

      const handleFinish = () => {
        if (hasCompletedAny) {
          setCurrentView('finish');
        }
      };

      return (
        <div className="bg-gradient-to-b from-gray-100 to-gray-200 min-h-screen text-gray-800">
          <div className="p-6">
            <div className="flex justify-between items-center mb-6">
              <button onClick={() => setCurrentView('home')} className="p-2 bg-white shadow-md rounded-full"><Home className="w-6 h-6 text-red-600" /></button>
              <h1 className="text-2xl font-bold text-red-700">Dagelijkse Missies</h1>
              <div className="p-2"><Volume2 className="w-6 h-6" /></div>
            </div>
            <div className="space-y-3">
              {missions.map((mission) => (
                <div key={mission.id} className={`p-4 rounded-2xl transition-all duration-300 shadow-md ${completedMissions[mission.id] ? 'bg-red-700 text-white' : 'bg-white'}`}>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-4">
                      <div className="text-4xl">{mission.icon}</div>
                      <div>
                        <div className="flex items-baseline space-x-2">
                            <h3 className="font-bold text-lg">{mission.name}</h3>
                            <p className={`text-xs font-semibold ${completedMissions[mission.id] ? 'text-white' : 'text-gray-500'}`}>{mission.time}</p>
                        </div>
                        <p className={`text-sm ${completedMissions[mission.id] ? 'opacity-90' : 'text-gray-600'}`}>{mission.description}</p>
                        {mission.points && (
                          <div className={`inline-flex items-center space-x-1 mt-1 px-2 py-1 rounded-full text-xs font-bold ${completedMissions[mission.id] ? 'bg-white bg-opacity-20 text-white' : 'bg-green-100 text-green-700'}`}>
                            <Star className="w-3 h-3" fill={completedMissions[mission.id] ? 'white' : 'currentColor'} />
                            <span>{mission.points} punten</span>
                          </div>
                        )}
                      </div>
                    </div>
                    <button
                      onClick={() => {
                        if (mission.id === 5) setShowDribbelInput(true);
                        else if (mission.id === 6) setShowGratitudeInput(true);
                        else completeMission(mission.id);
                      }}
                      disabled={completedMissions[mission.id]}
                      className={`p-3 rounded-full transition-transform transform hover:scale-110 ${completedMissions[mission.id] ? 'bg-white text-red-700' : 'bg-gray-200 text-gray-700'}`}>
                      {completedMissions[mission.id] ? <CheckCircle className="w-8 h-8" /> : <Circle className="w-8 h-8" />}
                    </button>
                  </div>
                </div>
              ))}
            </div>

            {hasCompletedAny && (
              <button
                onClick={handleFinish}
                className="w-full mt-6 bg-red-600 text-white font-bold py-4 px-6 rounded-full text-lg shadow-lg hover:bg-red-700 transition-colors flex items-center justify-center"
              >
                <Moon className="w-6 h-6 mr-2" />
                Dag Afsluiten
              </button>
            )}
          </div>
        </div>
      );
    };

  const FinishScreen = () => {
    // Calculate today's earned points
    const todayPoints = missions
      .filter(m => completedMissions[m.id])
      .reduce((sum, m) => sum + (m.points || 0), 0);

    const dreamMessages = [
      "...een geweldige goal die je scoort! ü•Ö",
      "...de mooiste pass die je geeft! ‚öΩ",
      "...een kampioenschap dat je wint! üèÜ",
      "...je vrienden en jullie samen lachen! üòÑ",
      "...de beste wedstrijd die je ooit speelt! ‚≠ê",
      "...een avontuur dat je beleeft! üåü",
      "...iets moois dat je morgen gaat doen! üåà",
      "...een moment waar je trots op bent! üí™",
      "...de Ajax Arena die voor jou juicht! üéâ",
      "...jouw allergrootste droom! ‚ú®"
    ];

    const [todayDream] = useState(() => {
      const randomIndex = Math.floor(Math.random() * dreamMessages.length);
      return dreamMessages[randomIndex];
    });

    return (
      <div className="bg-gradient-to-b from-red-700 to-red-900 min-h-screen text-white flex flex-col items-center justify-center p-6">
        <div className="text-center max-w-md">
          <div className="text-8xl mb-6 animate-bounce">üåô‚ú®</div>
          <h1 className="text-4xl font-bold mb-4">Goed Gedaan!</h1>
          <p className="text-xl mb-8">Je hebt vandaag missies volbracht!</p>

          <div className="bg-white text-gray-800 rounded-3xl p-8 mb-8 shadow-2xl">
            <p className="text-sm font-semibold text-gray-600 mb-2">Vandaag verdiend:</p>
            <div className="flex items-center justify-center space-x-3 mb-4">
              <Trophy className="w-12 h-12 text-yellow-500" />
              <p className="text-6xl font-bold text-red-600">+{todayPoints}</p>
            </div>
            <p className="text-lg font-bold text-gray-700">punten!</p>

            <div className="mt-6 pt-6 border-t border-gray-200">
              <p className="text-sm font-semibold text-gray-600 mb-2">Totaal punten:</p>
              <p className="text-3xl font-bold text-red-600">{points.totalPoints}</p>
            </div>
          </div>

          <div className="bg-white bg-opacity-10 backdrop-blur rounded-2xl p-6 mb-8 border-2 border-white border-opacity-20">
            <p className="text-lg font-semibold mb-3">üí≠ Droom nu over...</p>
            <p className="text-2xl font-bold">{todayDream}</p>
          </div>

          <p className="text-lg mb-8 opacity-90">Welterusten, kampioen! üèÜ</p>

          <button
            onClick={onLogout}
            className="bg-white text-red-700 font-bold py-4 px-8 rounded-full text-lg shadow-lg hover:bg-gray-100 transition-colors"
          >
            Sluiten
          </button>
        </div>
      </div>
    );
  };

  const ScorecardScreen = () => (
      <div className="bg-gray-100 min-h-screen text-gray-800 p-6">
          <div className="flex justify-between items-center mb-6">
              <button onClick={() => setCurrentView('home')} className="p-2 bg-white shadow-md rounded-full"><Home className="w-6 h-6 text-red-600" /></button>
              <h1 className="text-2xl font-bold text-red-700">Scorekaart</h1>
              <div className="w-10"></div>
          </div>
          <div className="bg-white rounded-3xl p-6 text-center shadow-lg mb-4">
              <h2 className="text-xl font-bold mb-2">Score Vandaag</h2>
              <p className="text-6xl font-bold text-red-600">{dailyGoals.toFixed(1)}<span className="text-2xl text-gray-500">/9.5</span></p>
              <p className="text-gray-600">goals behaald</p>
          </div>
           <div className="bg-white rounded-3xl p-6 shadow-lg">
              <h2 className="text-xl font-bold mb-4 text-center">Week Beloningen</h2>
              <div className="space-y-3">
                  {Object.values(weeklyRewards).map(reward => (
                      <div key={reward.title} className="flex items-center">
                          <div className={`p-3 rounded-full mr-4 ${weeklyGoals >= reward.threshold ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}`}>
                              {weeklyGoals >= reward.threshold ? <CheckCircle/> : <Circle/>}
                          </div>
                          <div>
                              <p className="font-bold">{reward.title}</p>
                              <p className="text-sm text-gray-600">{reward.threshold} goals</p>
                          </div>
                      </div>
                  ))}
              </div>
               <div className="mt-4 pt-4 border-t border-gray-200 text-center">
                    <p className="font-bold text-lg">Week Totaal: {weeklyGoals.toFixed(1)}<span className="font-normal text-gray-500">/35</span></p>
               </div>
          </div>
      </div>
  );

  const BadgesScreen = () => (
      <div className="bg-gray-100 min-h-screen text-gray-800 p-6">
          <div className="flex justify-between items-center mb-6">
              <button onClick={() => setCurrentView('home')} className="p-2 bg-white shadow-md rounded-full"><Home className="w-6 h-6 text-red-600" /></button>
              <h1 className="text-2xl font-bold text-red-700">Badges</h1>
              <div className="w-10"></div>
          </div>
           <div className="grid grid-cols-2 gap-4">
              {badges.map(badge => (
                  <div key={badge.id} className={`p-4 rounded-2xl text-center shadow-md ${badge.unlocked ? 'bg-red-600 text-white' : 'bg-white text-gray-700'}`}>
                      <div className="text-4xl mb-2">{badge.icon}</div>
                      <h3 className="font-bold">{badge.name}</h3>
                      {badge.unlocked && <p className="text-xs opacity-80">Behaald!</p>}
                  </div>
              ))}
          </div>
      </div>
  );

  const renderContent = () => {
    switch (currentView) {
      case 'home': return <HomeScreen />;
      case 'missions': return <MissionsScreen />;
      case 'finish': return <FinishScreen />;
      case 'points': return <PointsDashboard onBack={() => setCurrentView('home')} />;
      default: return <HomeScreen />;
    }
  };

  return (
    <div className="min-h-screen bg-gray-900 md:flex md:items-center md:justify-center">
      <div className="w-full md:max-w-md bg-white overflow-hidden font-sans md:shadow-2xl min-h-screen md:min-h-0">
        <RewardModal
          show={showReward}
          rewardType={rewardType}
          onClose={() => setShowReward(false)}
          weeklyRewards={weeklyRewards}
        />
        <DribbelInputModal
          show={showDribbelInput}
          onClose={() => setShowDribbelInput(false)}
          onSubmit={handleDribbelSubmit}
          dareValue={dribbelDare}
          onDareChange={(e) => setDribbelDare(e.target.value)}
          tryValue={dribbelTry}
          onTryChange={(e) => setDribbelTry(e.target.value)}
        />
        <GratitudeInputModal
          show={showGratitudeInput}
          onClose={() => setShowGratitudeInput(false)}
          onSubmit={handleGratitudeSubmit}
          value1={gratitude1}
          onChange1={(e) => setGratitude1(e.target.value)}
          value2={gratitude2}
          onChange2={(e) => setGratitude2(e.target.value)}
          value3={gratitude3}
          onChange3={(e) => setGratitude3(e.target.value)}
        />
        <LevelUpModal
          show={points.showLevelUp}
          level={points.newLevel}
          onClose={() => points.setShowLevelUp(false)}
        />
        <AchievementModal
          show={points.showAchievement !== null}
          achievement={points.showAchievement}
          onClose={() => points.setShowAchievement(null)}
        />
        {renderContent()}
      </div>
    </div>
  );
};

// Wrapper component with PointsProvider
const AjaxSleepApp = (props) => (
  <PointsProvider userId={props.user?.id}>
    <AjaxSleepAppContent {...props} />
